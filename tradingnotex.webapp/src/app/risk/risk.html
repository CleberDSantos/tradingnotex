<section class="card p-4">
  <h2 class="text-xl font-semibold mb-3 flex items-center gap-2">🛡️ Gestão de Risco <span class="chip bg-gradient-to-r from-accent/20 to-accent/30">Meta vs Loss</span></h2>
  <div class="grid md:grid-cols-4 gap-4 items-end">
    <div>
      <div class="text-xs muted mb-1">Meta diária (take-profit) €</div>
      <input [(ngModel)]="riskData.goalEUR" type="number" step="0.01" class="w-full bg-blacker border border-edge rounded px-3 py-2" placeholder="ex: 2.00">
    </div>
    <div>
      <div class="text-xs muted mb-1">Loss diário (máx. perda) €</div>
      <input [(ngModel)]="riskData.maxLossEUR" type="number" step="0.01" class="w-full bg-blacker border border-edge rounded px-3 py-2" placeholder="ex: 2.00">
    </div>
    <div>
      <div class="text-xs muted mb-1">Selecionar dia</div>
  <div class="relative">
  <!-- Botão/trigger do datepicker -->
  <button
    #pickerBtn
    type="button"
    (click)="toggleCalendar($event)"
    class="w-full bg-blacker border border-edge rounded px-3 py-2 flex items-center justify-between"
  >
    <span class="truncate">
      {{ riskData.selectedDay || 'Todos' }}
    </span>
    <span class="flex items-center gap-2">
      <span
        *ngIf="riskData.selectedDay"
        class="inline-block w-2.5 h-2.5 rounded-full"
        [ngClass]="{
          'bg-good': dayStatusMap.get(riskData.selectedDay) === 'gain',
          'bg-bad' : dayStatusMap.get(riskData.selectedDay) === 'loss',
          'bg-gray-500': dayStatusMap.get(riskData.selectedDay) === 'neutral'
        }"
      ></span>
      ▼
    </span>
  </button>

  <!-- Painel do calendário ABSOLUTE -->
  <div
    #calendarPanel
    *ngIf="calendarOpen"
    class="absolute left-0 mt-2 z-50 w-[292px] rounded-lg border border-edge bg-blacker shadow-xl p-3"
  >
    <div class="flex items-center justify-between mb-2">
      <button class="px-2 py-1 border border-edge rounded" (click)="prevMonth()">◀</button>
      <div class="text-sm">{{ currentMonth | date:'LLLL yyyy' }}</div>
      <button class="px-2 py-1 border border-edge rounded" (click)="nextMonth()">▶</button>
    </div>

    <div class="grid grid-cols-7 gap-1 text-center text-xs muted mb-1">
      <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div>
    </div>

    <div class="grid grid-cols-7 gap-1">
      <button
        *ngFor="let d of calendarDays"
        class="py-2 rounded border transition hover:border-cyanx/50"
        [disabled]="!d.inMonth"
        [ngClass]="{
          'opacity-40 cursor-not-allowed': !d.inMonth,
          'border-good bg-good/10': d.status==='gain' && d.inMonth,
          'border-bad  bg-bad/10':  d.status==='loss' && d.inMonth,
          'border-edge': d.status==='neutral' || !d.inMonth,
          'ring-2 ring-cyanx': riskData.selectedDay === d.dateStr
        }"
        (click)="selectCalendarDay(d.dateStr)"
      >
        <span class="text-sm">{{ d.dayNum }}</span>
      </button>
    </div>

    <div class="text-xs muted mt-3 flex items-center gap-3">
      <span>Legenda:</span>
      <span class="text-good">🟢 Gain</span>
      <span class="text-bad">🔴 Loss</span>
      <span>⚪ Neutro</span>
      <button
        class="ml-auto px-2 py-1 border border-edge rounded hover:border-cyanx/50"
        (click)="selectAllDays()"
      >
        Todos
      </button>
    </div>
  </div>
</div>

    </div>
    <div class="flex gap-2">
      <button (click)="applyFilters()" class="px-4 py-2 rounded bg-good/20 hover:bg-good/30 border border-good/50">✅ Aplicar</button>
      <button (click)="clearFilters()" class="px-4 py-2 rounded border border-edge hover:bg-card">🔄 Reset</button>
    </div>
  </div>

  <div class="grid md:grid-cols-4 gap-4 mt-4">
    <div class="card p-4 border-l-4 border-cyanx">
      <div class="text-xs muted">Impacto das quebras (período)</div>
      <div class="text-2xl font-extrabold mt-2">{{ riskData.impact | currency:'EUR' }}</div>
      <div class="text-xs muted mt-1">Quanto teria melhorado seguindo as regras</div>
    </div>
    <div class="card p-4 border-l-4 border-accent">
      <div class="text-xs muted">Dias com ganância</div>
      <div class="text-2xl font-extrabold text-accent mt-2">{{ riskData.greedDays }}</div>
      <div class="text-xs muted mt-1">Continuou após bater a meta</div>
    </div>
    <div class="card p-4 border-l-4 border-bad">
      <div class="text-xs muted">Dias com loss quebrado</div>
      <div class="text-2xl font-extrabold text-bad mt-2">{{ riskData.lossDays }}</div>
      <div class="text-xs muted mt-1">Passou do limite de perda</div>
    </div>
    <div class="card p-4 border-l-4 border-good">
      <div class="text-xs muted">Dias obedecendo regras</div>
      <div class="text-2xl font-extrabold text-good mt-2">{{ riskData.compliantDays }}</div>
      <div class="text-xs muted mt-1">Nenhuma quebra detectada</div>
    </div>
  </div>

  <div class="mt-6">
    <h3 class="text-lg font-semibold mb-2">📈 Resultado diário — <span class="text-green-400">disciplinado</span> vs <span class="text-red-400">real</span></h3>
    <div id="chartDailyComparison" style="height: 340px;" class="rounded-lg"></div>
    <div class="text-xs muted mt-2 flex gap-4"><span>📍 Marcadores:</span><span class="text-yellow-300">▲ Ganância</span><span class="text-red-400">✖ Loss quebrado</span></div>
  </div>

  <div class="mt-6">
    <h3 class="text-lg font-semibold mb-2">📊 Intraday do dia selecionado</h3>
    <div id="chartIntraday" style="height: 360px;" class="rounded-lg"></div>
  </div>
</section>
