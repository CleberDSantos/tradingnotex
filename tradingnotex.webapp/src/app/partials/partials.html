<section class="grid md:grid-cols-4 gap-6">
  <div class="card p-4">
    <h3 class="font-semibold mb-3">üéØ Objetivo & Contratos</h3>
    <label class="text-xs text-gray-400">Meta (cash)</label>
    <select [(ngModel)]="partialPlanData.targetCash" class="w-full mt-1 px-3 py-2 rounded text-white bg-[#1b2330] border border-[#2a3441] focus:outline-none">
      <option value="180">Meta 1 ‚Äî $180</option>
      <option value="240">Meta 2 ‚Äî $240</option>
      <option value="300">Meta 3 ‚Äî $300</option>
      <option value="360">Fora da curva ‚Äî $360</option>
    </select>
    <label class="text-xs text-gray-400 block mt-3"># Contratos (MNQ)</label>
    <input [(ngModel)]="partialPlanData.contracts" type="number" min="1" max="10" value="2" class="w-full mt-1 px-3 py-2 rounded text-white bg-[#1b2330] border border-[#2a3441] focus:outline-none">
    <p class="text-xs text-gray-500 mt-2">Refer√™ncia planilha (2,3,5,8,10).</p>
  </div>
  <div class="card p-4">
    <h3 class="font-semibold mb-3">üõë Stop & Dire√ß√£o</h3>
    <label class="text-xs text-gray-400">Stop por trade (pontos)</label>
    <input [(ngModel)]="partialPlanData.stopPts" type="number" step="0.25" value="12" class="w-full mt-1 px-3 py-2 rounded text-white bg-[#1b2330] border border-[#2a3441] focus:outline-none">
    <label class="text-xs text-gray-400 block mt-3">Dire√ß√£o</label>
    <select [(ngModel)]="partialPlanData.direction" class="w-full mt-1 px-3 py-2 rounded text-white bg-[#1b2330] border border-[#2a3441] focus:outline-none">
      <option value="long">Long</option>
      <option value="short">Short</option>
    </select>
    <label class="text-xs text-gray-400 block mt-3">Pre√ßo de Entrada</label>
    <input [(ngModel)]="partialPlanData.entry" type="number" step="0.25" value="20000" class="w-full mt-1 px-3 py-2 rounded text-white bg-[#1b2330] border border-[#2a3441] focus:outline-none">
  </div>
  <div class="card p-4">
    <h3 class="font-semibold mb-3">‚öôÔ∏è Parciais</h3>
    <label class="text-xs text-gray-400">Distribui√ß√£o dos contratos</label>
    <div class="grid grid-cols-3 gap-2 mt-1">
      <input [(ngModel)]="partialPlanData.p1" type="number" min="0" max="100" value="50" class="px-3 py-2 rounded text-white bg-[#1b2330] border border-[#2a3441]">
      <input [(ngModel)]="partialPlanData.p2" type="number" min="0" max="100" value="30" class="px-3 py-2 rounded text-white bg-[#1b2330] border border-[#2a3441]">
      <input [(ngModel)]="partialPlanData.p3" type="number" min="0" max="100" value="20" class="px-3 py-2 rounded text-white bg-[#1b2330] border border-[#2a3441]">
    </div>
    <p class="text-xs text-gray-500 mt-2">Soma = 100% (P1/P2/Final).</p>
    <label class="text-xs text-gray-400 block mt-3">N√≠veis (em R)</label>
    <div class="grid grid-cols-3 gap-2 mt-1">
      <input [(ngModel)]="partialPlanData.r1" type="number" step="0.25" value="1.0" class="px-3 py-2 rounded text-white bg-[#1b2330] border border-[#2a3441]">
      <input [(ngModel)]="partialPlanData.r2" type="number" step="0.25" value="1.5" class="px-3 py-2 rounded text-white bg-[#1b2330] border border-[#2a3441]">
      <input [(ngModel)]="partialPlanData.r3" type="number" step="0.25" value="2.0" class="px-3 py-2 rounded text-white bg-[#1b2330] border border-[#2a3441]">
    </div>
  </div>
  <div class="card p-4">
    <h3 class="font-semibold mb-3">üìè Convers√µes (MNQ)</h3>
    <div class="text-sm flex justify-between"><span>$ por ponto / contrato</span><strong id="usdPerPoint">${{ partialPlanData.usdPerPointPerContract || '2.00' }}</strong></div>
    <div class="text-sm flex justify-between mt-1"><span>Stop em $</span><strong id="stopCash">${{ ((partialPlanData.stopPts || 12) * (partialPlanData.usdPerPointPerContract || 2) * (partialPlanData.contracts || 2)).toFixed(2) }}</strong></div>
    <div class="text-sm flex justify-between mt-1"><span>Risco do trade</span><strong id="tradeRisk">${{ ((partialPlanData.stopPts || 12) * (partialPlanData.usdPerPointPerContract || 2) * (partialPlanData.contracts || 2)).toFixed(2) }}</strong></div>
  </div>
</section>

<section class="card p-4 mt-4">
  <!-- Loading Indicator -->
  <div *ngIf="loading" class="flex justify-center items-center py-4">
    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-cyanx"></div>
  </div>

  <!-- Error Message -->
  <div *ngIf="error" class="bg-bad/20 border border-bad/50 text-bad px-4 py-3 rounded mb-4">
    {{ error }}
  </div>

  <div class="flex items-center justify-between mb-3">
    <h3 class="font-semibold">üóÇÔ∏è Plano de Execu√ß√£o</h3>
    <div class="flex gap-2">
      <button (click)="generatePartialPlan()" [disabled]="loading" class="px-3 py-2 rounded bg-cyanx/20 border border-cyanx/40 hover:bg-cyanx/30">Calcular</button>
      <button (click)="exportPlan()" [disabled]="!planResult" class="px-3 py-2 rounded bg-gradient-to-r from-cyanx/20 to-cyanx/30 border border-cyanx/50">üìÑ Exportar Plano</button>
    </div>
  </div>
  <div class="overflow-x-auto">
    <table class="w-full text-sm">
      <thead class="border-b border-edge">
        <tr>
          <th class="text-left py-2">Etapa</th>
          <th class="text-right py-2">R (x)</th>
          <th class="text-right py-2">Pontos</th>
          <th class="text-right py-2">Pre√ßo</th>
          <th class="text-right py-2">Contratos</th>
          <th class="text-right py-2">PnL Parcial</th>
          <th class="text-right py-2">PnL Acumulado</th>
          <th class="text-left py-2">A√ß√£o de Stop</th>
        </tr>
      </thead>
      <tbody id="planBody">
        <tr *ngIf="!planResult" class="border-b border-edge/40">
          <td class="py-2">Parcial 1</td>
          <td class="text-right">1.00</td>
          <td class="text-right">12.00</td>
          <td class="text-right">20,012.00</td>
          <td class="text-right">1</td>
          <td class="text-right text-good">$24.00</td>
          <td class="text-right text-good">$24.00</td>
          <td class="text-left text-gray-300">Mover stop para BE se tocar P1</td>
        </tr>
        <tr *ngIf="!planResult" class="border-b border-edge/40">
          <td class="py-2">Parcial 2</td>
          <td class="text-right">1.50</td>
          <td class="text-right">18.00</td>
          <td class="text-right">20,018.00</td>
          <td class="text-right">0</td>
          <td class="text-right text-good">$0.00</td>
          <td class="text-right text-good">$24.00</td>
          <td class="text-left text-gray-300">Trail: √∫ltimo swing/0.5R</td>
        </tr>
        <tr *ngIf="!planResult" class="border-b border-edge/40">
          <td class="py-2">Final</td>
          <td class="text-right">2.00</td>
          <td class="text-right">24.00</td>
          <td class="text-right">20,024.00</td>
          <td class="text-right">1</td>
          <td class="text-right text-good">$48.00</td>
          <td class="text-right text-good">$72.00</td>
          <td class="text-left text-gray-300">Manter trail / alvo da meta</td>
        </tr>
        <tr *ngFor="let row of planResult?.rows" class="border-b border-edge/40">
          <td class="py-2">{{ row.label }}</td>
          <td class="text-right">{{ row.r }}</td>
          <td class="text-right">{{ row.points }}</td>
          <td class="text-right">{{ row.price }}</td>
          <td class="text-right">{{ row.lots }}</td>
          <td class="text-right" [ngClass]="row.pnL >= 0 ? 'text-good' : 'text-bad'">${{ row.pnL }}</td>
          <td class="text-right" [ngClass]="row.pnLAccum >= 0 ? 'text-good' : 'text-bad'">${{ row.pnLAccum }}</td>
          <td class="text-left text-gray-300">{{ row.stopAction }}</td>
        </tr>
      </tbody>
    </table>
    <div class="mt-3 text-xs text-gray-300">üí° Para equiparar √† meta de ${{ partialPlanData.targetCash || 180 }}, ajuste o alvo final para ~ <strong>{{ ((partialPlanData.targetCash || 180) / ((partialPlanData.stopPts || 12) * (partialPlanData.usdPerPointPerContract || 2) * (partialPlanData.contracts || 2)) * (partialPlanData.r3 || 2)).toFixed(2) }}</strong> R (‚âà {{ ((partialPlanData.targetCash || 180) / ((partialPlanData.usdPerPointPerContract || 2) * (partialPlanData.contracts || 2))).toFixed(2) }} pts).</div>
  </div>
  <div class="grid md:grid-cols-3 gap-4 mt-4">
    <div class="bg-edge/50 rounded p-3">
      <div class="text-xs text-gray-400">Meta (pontos p/ contratos)</div>
      <div class="text-lg font-bold" id="metaPtsVis">{{ ((partialPlanData.targetCash || 180) / ((partialPlanData.usdPerPointPerContract || 2) * (partialPlanData.contracts || 2))).toFixed(2) }} pts ‚Ä¢ {{ partialPlanData.contracts || 2 }} ct</div>
      <div class="text-xs text-gray-500">Ex.: {{ ((partialPlanData.targetCash || 180) / ((partialPlanData.usdPerPointPerContract || 2) * (partialPlanData.contracts || 2))).toFixed(2) }}pts com {{ partialPlanData.contracts || 2 }} contratos = ${{ partialPlanData.targetCash || 180 }}</div>
    </div>
    <div class="bg-edge/50 rounded p-3">
      <div class="text-xs text-gray-400">PnL se carregar at√© a Meta</div>
      <div class="text-lg font-bold text-good" id="metaCashVis">${{ partialPlanData.targetCash || '180.00' }}</div>
    </div>
    <div class="bg-edge/50 rounded p-3">
      <div class="text-xs text-gray-400">PnL do plano de parciais</div>
      <div class="text-lg font-bold" id="planoCashVis" [ngClass]="(planResult?.planPnL || 0) >= 0 ? 'text-good' : 'text-bad'">${{ planResult?.planPnL || '72.00' }}</div>
      <div class="text-xs text-gray-500">Se menor que a meta, ajuste R3 ou %.</div>
    </div>
  </div>
</section>
